---
title: "Biostat 203B Homework 2"
author: Pablo Geraldo
data: \today
subtitle: Due ~~Feb 5~~ Feb 10 @ 11:59PM
output: 
  html_document:
    toc: true
    toc_depth: 4 
---

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r setup}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, cache.lazy = FALSE)
library(tidyverse)
library(data.table)
library(lubridate)
```

```{r}
# Function to create the path to MIMIC data
# If Linux (i.e., in the server), use the local path
# If macOS (i.e., personal laptop), use the box path
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/usr/203b-data/mimic-iv"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "/Users/huazhou/Documents/Box Sync/MIMIC/mimic-iv-0.4"
}
```

Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-IV](https://mimic-iv.mit.edu) data introduced in [homework 1](https://ucla-biostat203b-2021winter.github.io/hw/hw1/hw1.html).

```{r}
# The bash equivalent will be this:
# tree -s -L 2 /Users/huazhou/Documents/Box\ Sync/MIMIC/mimic-iv-0.4
# But here, we use shQuote to avoid going back and forth from bash to R
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. PhysioNet credential

At this moment, you should already get credentialed on the PhysioNet. Please include a screenshot of your `Data Use Agreement for the MIMIC-IV (v0.4)`.

![Here is a copy to my credentials to use MIMIC-IV data](PabloGeraldo_MIMIC_IV_Credentials.png)


## Q2. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. Is there any speed difference? (Hint: R function `system.time` measures runtimes.)

In this homework, we stick to the tidyverse or data.table.

Let's figure out the reading times for the `admissions` file. We will use the `system.time` function to measure how long does it takes for each function to run. To avoid repeating the waiting time when knitting, I am commenting out the functions and pasting the output of each run.

As we can see, the base R function `read.csv` is the slowest one, taking around 46 second to read the data. The tidyverse-based function `read_csv` greatly improves upon the base R version, reading the data in 4.5 second. Finally, `data.table::fread` further improves completing the task in 2.7 seconds. One would expect the different to be even more substantial for bigger datasets.

```{r, eval=FALSE, cache=TRUE}
# First, use the native read.csv
read.csv(paste0(mimic_path,"/core/admissions.csv.gz")) %>%
  system.time()
#   user  system elapsed 
# 46.386   0.002  46.428 

# Second, use tidyverse read_csv
read_csv(paste0(mimic_path,"/core/admissions.csv.gz")) %>%
  system.time()
#   user  system elapsed 
#  4.563   0.000   4.654 

# Finally, use data.table fread function
fread(paste0(mimic_path,"/core/admissions.csv.gz")) %>%
  system.time()
#   user  system elapsed 
#  2.728   0.000   1.708
```

## Q3. ICU stays

`icustays.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate numerics or graphs:   

- how many unique `stay_id`?  
- how many unique `subject_id`?  

To answer those questions, I will use the following code. Basically, this is subsetting the data to the list of unique ids, and then counting the length of the resulting vector.

```{r, eval=FALSE}
# First, let's read the data
icustays <- 
  fread(paste0(mimic_path,"/icu/icustays.csv.gz"))

# Unique stay_id
# Notice that the number of unique stay_id
# is the same as the rows in the data 
# nrow(icustays)
length(unique(icustays$stay_id))

# Unique subject_id
length(unique(icustays$subject_id))
```

We can see that there are `r length(unique(icustays$stay_id))` unique `stay_id` and `r length(unique(icustays$subject_id))` unique `stay_id` in the data. 

- length of ICU stay  

For this question, it is probably more convenient to graph the data and explore the overall distribution of the stays in the ICU. We will also need to create the variable for the length of stay.

First, let's try an histogram

```{r}
icustays %>%
  # Create the staytime variable
  # I use the function lubridate::as_date
  # The resulting is a "difftime" variable type
  # Measured in numbers of days
  mutate(staytime = as_date(outtime) - as_date(intime),
         staydays = as.numeric(staytime),
         staylog = log(staydays)) %>% 
  ggplot(aes(x = staylog)) +
  geom_histogram()
```

- first ICU unit  

```{r}

```

- last ICU unit  

```{r}

````


## Q4. `admission` data

Information of the patients admitted into hospital is available in `admissions.csv.gz`. See <https://mimic-iv.mit.edu/docs/datasets/core/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs. Explain any patterns you observe.   

- admission year  
- admission month  
- admission month day  
- admission week day  
- admission hour (anything unusual?)  
- number of deaths in each year  
- admission type  
- number of admissions per patient  
- admission location  
- discharge location  
- insurance  
- language  
- martial status  
- ethnicity  
- death 

Note it is possible that one patient (uniquely identified by the `subject_id`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on unique patients. 

## Q5. `patient` data

Explore `patients.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/core/patients/>) and summarize following variables using appropriate numerics and graphs:  

- `gender`  
- `anchor_age` (explain pattern you see)

## Q6. Lab results

`labevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/hosp/labevents/>) contains all laboratory measurements for patients. 

We are interested in the lab measurements of creatinine (50912), potassium (50971), sodium (50983), chloride (50902), bicarbonate (50882), hematocrit (51221), white blood cell count (51301), glucose (50931), magnesium (50960), calcium (50893), and lactate (50813). Find the `itemid`s of these lab measurements from `d_labitems.csv.gz` and retrieve a subset of `labevents.csv.gz` only containing these items.

## Q7. Vitals from chartered events

We are interested in the vitals for ICU patients: heart rate, mean and systolic blood pressure (invasive and noninvasive measurements combined), body temperature, SpO2, and respiratory rate. Find the `itemid`s of these vitals from `d_items.csv.gz` and retrieve a subset of `chartevents.csv.gz` only containing these items.

`chartevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `itemid` variable indicates a single measurement type in the database. The `value` variable is the value measured for `itemid`.

`d_items.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/d_items/>) is the dictionary for the `itemid` in `chartevents.csv.gz`. 

## Q8. Putting things together

Let us create a tibble for all ICU stays, where rows are  

- first ICU stay of each unique patient  
- adults (age at admission > 18)  

and columns contain at least following variables  

- all variables in `icustays.csv.gz`  
- all variables in `admission.csv.gz`  
- all variables in `patients.csv.gz`  
- first lab measurements during ICU stay  
- first vitals measurement during ICU stay  
- an indicator variable whether the patient died within 30 days of hospital admission  

